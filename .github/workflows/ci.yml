name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
  push:
  schedule:
    - cron:  '0 1 * * *'

jobs:
  yard-lint:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    env:
      BUNDLE_GEMFILE: Gemfile.lint
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - name: Set up Ruby
        uses: ruby/setup-ruby@09a7688d3b55cf0e976497ff046b70949eeaccfd # v1
        with:
          ruby-version: '4.0'
          bundler-cache: true
      - name: Run yard-lint
        run: bundle exec yard-lint

  lostconf:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d6e4700bb7bfbed0b0e4 # v6
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run lostconf
        run: npx lostconf --fail-on-stale

  rubocop-non-rails:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    env:
      BUNDLE_GEMFILE: Gemfile.lint
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - name: Set up Ruby
        uses: ruby/setup-ruby@09a7688d3b55cf0e976497ff046b70949eeaccfd # v1
        with:
          ruby-version: '4.0'
          bundler-cache: true
      - name: Run rubocop on non-rails
        run: |
          cd v2.4-non-rails
          bundle exec --gemfile=../Gemfile.lint rubocop

  v2_4-non-rails-specs:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby:
          - '4.0'
          - '3.4'
          - '3.3'
          - '3.2'
        include:
          - ruby: '4.0'
            coverage: 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Install package dependencies
        run: "[ -e $APT_DEPS ] || sudo apt-get install -y --no-install-recommends $APT_DEPS"
      - name: Set up Ruby
        uses: ruby/setup-ruby@09a7688d3b55cf0e976497ff046b70949eeaccfd # v1
        with:
          ruby-version: ${{matrix.ruby}}
          bundler: 'latest'
      - name: Install latest bundler
        run: |
          cd v2.4-non-rails

          gem install bundler --no-document

          bundle config set without 'tools benchmarks docs'
      - name: Bundle install
        run: |
          cd v2.4-non-rails
          # For Ruby 4.0, use local gem path to avoid permission issues with default gems
          if [ "${{ matrix.ruby }}" = "4.0" ]; then
            bundle config set path vendor/bundle
          fi
          bundle config set without development
          bundle install --jobs 4 --retry 3
      - name: Run all tests
        env:
          GITHUB_COVERAGE: ${{matrix.coverage}}
        run: |
          cd v2.4-non-rails
          bundle exec rspec

  rubocop-rails:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    env:
      BUNDLE_GEMFILE: Gemfile.lint
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - name: Set up Ruby
        uses: ruby/setup-ruby@09a7688d3b55cf0e976497ff046b70949eeaccfd # v1
        with:
          ruby-version: '4.0'
          bundler-cache: true
      - name: Run rubocop on rails
        run: |
          cd v2.4-rails
          bundle exec --gemfile=../Gemfile.lint rubocop

  v2_4-rails-specs:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby:
          - '4.0'
          - '3.4'
          - '3.3'
          - '3.2'
        include:
          - ruby: '4.0'
            coverage: 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Install package dependencies
        run: "[ -e $APT_DEPS ] || sudo apt-get install -y --no-install-recommends $APT_DEPS"
      - name: Set up Ruby
        uses: ruby/setup-ruby@09a7688d3b55cf0e976497ff046b70949eeaccfd # v1
        with:
          ruby-version: ${{matrix.ruby}}
          bundler: 'latest'
      - name: Install latest bundler
        run: |
          cd v2.4-rails
          gem install bundler --no-document

          bundle config set without 'tools benchmarks docs'
      - name: Bundle install
        run: |
          cd v2.4-rails
          # For Ruby 4.0, use local gem path to avoid permission issues with default gems
          if [ "${{ matrix.ruby }}" = "4.0" ]; then
            bundle config set path vendor/bundle
          fi
          bundle config set without development
          bundle install --jobs 4 --retry 3
      - name: Setup db
        run: |
          cd v2.4-rails
          bundle exec rake db:create
          bundle exec rake db:test:prepare
      - name: Run all tests
        env:
          GITHUB_COVERAGE: ${{matrix.coverage}}
        run: |
          cd v2.4-rails
          bundle exec rspec
